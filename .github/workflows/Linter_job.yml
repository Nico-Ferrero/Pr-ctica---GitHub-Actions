name: Main Workflow
on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  Linter_Job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar .eslintrc.json
        run: npx eslint "**/*.{js,jsx,ts,tsx}" --config .eslintrc.json

  Cypress_Job:
    needs: Linter_Job
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar pruebas Cypress
        run: npm run build && npm start & sleep 10 && npx cypress run

      - name: Guardar resultados de pruebas en el result.txt
        run: npx cypress run > result.txt

      - name: Subir resultados de pruebas a la carpeta de resultados
        uses: actions/upload-artifact@v4
        with:
          name: cypress-results
          path: result.txt

  Add_Badge_Job:
    needs: Cypress_Job
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Instalar dependencias
        run: npm ci

      - name: Descargar resultados de pruebas
        uses: actions/download-artifact@v4
        with:
          name: cypress-results
          path: ./results

      - name: Generar_output
        run: cat ./results/result.txt > output.txt

      - name: Determinar_resultado
        id: determine
        uses: ./.github/Determinar_resultado_nico
        with:
          result-file: output.txt
      
      - name: Remover_badge_antigua
        run: |
          sed -i '/!\[Test Status\]/d' README.md
      
      - name: Añadir_badge_readme
        if: ${{ steps.determine.outputs.test-passed == 'true' }}
        run: |
          sed -i '1i ![Test Status](https://img.shields.io/badge/test-success-green)' README.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Añadir_badge_readme_failure
        if: ${{ steps.determine.outputs.test-passed == 'false' }}
        run: |
          sed -i '1i ![Test Status](https://img.shields.io/badge/test-failure-red)' README.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit changes
        run: |
          git add .
          git commit -m "Actualizar badge de estado de tests"
          git push origin main
      
  Deploy_job:
    needs: Cypress_Job
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Instalar dependencias
        run: npm ci

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-args: --prod
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./

  Notification_job:
    needs: [Add_Badge_Job, Cypress_Job, Linter_Job]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Comprobar_errores_jobs
        id: check
        run: |
          echo "Checking job results..."
          FAILED=false
          
          if [ "${{ needs.Linter_Job.result }}" != "success" ]; then
            echo "❌ Linter Job failed or was cancelled."
            FAILED=true
          else
            echo "✅ Linter Job succeeded."
          fi
          
          if [ "${{ needs.Cypress_Job.result }}" != "success" ]; then
            echo "❌ Cypress Job failed or was cancelled."
            FAILED=true
          else
            echo "✅ Cypress Job succeeded."
          fi
          
          if [ "${{ needs.Add_Badge_Job.result }}" != "success" ]; then
            echo "❌ Add Badge Job failed or was cancelled."
            FAILED=true
          else
            echo "✅ Add Badge Job succeeded."
          fi
          
          if [ "$FAILED" = "true" ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "⚠️ Some jobs failed. Please check the logs."
          else
            echo "result=success" >> $GITHUB_OUTPUT
            echo "🎉 All previous jobs succeeded!"
          fi
    
      - name: Enviar notificación por email
        uses: ./.github/Notification_nico
        with:
          test-result: ${{ steps.check.outputs.result }}
          email-to: ${{ secrets.NOTIFICATION_EMAIL }}
          smtp-username: ${{ secrets.SMTP_USERNAME }}
          smtp-password: ${{ secrets.SMTP_PASSWORD }}
